<body>
  <script type="text/javascript" src="https://cdn.apple-cloudkit.com/ck/2/cloudkit.js" async></script>
  <div id="apple-sign-out-button"></div>
  <div id="apple-sign-in-button"></div>
  <div id="to-do">
    <h3>This test suite requires some user input:</h3> 
    <ul>
      <li>Open the console to see the tests</li>
      <li>Sign into your icloud account</li>
      <li>Sign out of your icloud account</li>
    <ul>
  </div>   
  <script type="text/javascript">

    let testCount = 0;
    let testPassed = 0;
    let tests = [];

    function test (text, func) {
      testCount++;
      tests.push(text);

      let resolver = (condition) => {
        if (condition === true || condition === false)
          
          if (condition)  { //passed
            console.log(text, "PASSED", testPassed, "of", testCount);
            testPassed++;
            tests.splice(tests.indexOf(text), 1);
          } else { //failed
            console.warn(text, "FAILED");
          }

        else {console.error(text, "INVALID CONDITION TYPE"); }
      };

      let rejecter = (err) => {
        console.error(text, "ERROR IN TEST");
        console.error(error);
      };

      func(resolver, rejecter);
    }

    window.addEventListener('cloudkitloaded', function () {

      // ## `ck-connect`

      // #### Summary
      // This module handles the interface between the web-browser and our Cloudkit container.

      // #### Functionality

      CloudKit.configure({
        containers: [{
          containerIdentifier: 'iCloud.com.coherent.staX',
          
          apiTokenAuth: {
            // And generate a web token through CloudKit Dashboard.
            apiToken: 'cabcc1115c6b118f192e08e7b1ca3dee05976f4b164f8047f59a1a53974ca46b',
            persist: true, // Sets a cookie.
            signInButton: {
              id: 'apple-sign-in-button',
              theme: 'black' // Other options: 'white', 'white-with-outline'.
            },
            signOutButton: {
              id: 'apple-sign-out-button',
              theme: 'black'
            }
          },

          environment: "development",

          zone: "default"

        }]
      });

      test("Cloudkit loads", (resolve, reject) => {
        resolve(CloudKit !== undefined && CloudKit !== null);
      });

      const container = CloudKit.getDefaultContainer()
      const publicDB = container.publicCloudDatabase;

      // * Authentication
      //   * It verifies whether a user is logged into iCloud
      //   * It listens for when a user logs in or out

      test("It verifies whether a user is logged into iCloud", (resolve, reject) => {

        container.setUpAuth().then((userInfo) => {
          resolve(userInfo === null);
        }).catch((err)=> {
          reject(err);
        });        
      });

      test("It listens for when a user logs in", (resolve, reject) => {
        container.whenUserSignsIn().then((userInfo) => {
          console.log(userInfo, "signed in");
          resolve(userInfo !== null);
        }).catch((err) => {reject(err);});
      });

      test("It listens for when a user logs out", (resolve, reject) => {
        container.whenUserSignsOut().then((userInfo) => {
          console.log(userInfo, "signed out");
          resolve(userInfo !== null);
        }).catch((err) => {reject(err);});
      });


 // * Facilities
 //   * It fetches a list of exisiting facilities
 //   * It listens for changes to exisiting facilities
 //   * It creates new facilities
 //   * It removes exisiting facilities
 //   * It updates existing facilities

 test("It fetches a list of existing facilities", (resolve, reject) => {
   publicDB.performQuery({recordType: 'STXFacility'}).then((response) => {
     if (response.hasErrors) {
       reject(response.errors[0]);
     } else {
       resolve(response.records.length > 0);
     }
 });

 test("It creates new facilities", (resolve, reject) => {

   let record = {
     recordType: 'STXFacility',
     fields: {
       nameA: {
         value: "Test Facility"
       },
     }
   };

   publicDB.saveRecords(record).then((response) => {
     if (response.hasErrors) {
       reject(response.errors[0]);
     } else {
       resolve(respons.records[0].nameA === "Test Facility");
     }

   }).then((recordName) => {

     test("It listens for changes to exisiting facilities", (resolve, reject) => {
       let querySubscription = {
         subscriptionType: 'query',
         subscriptionID: userInfo.userRecordName,
         firesOn: ['update'],
         query: { recordType: 'STXFacility', recordName: recordName}
       };

       publicDB.saveSubscriptions(querySubscription).then( (response) => {
         if (response.hasErrors) {
           reject(response.errors[0]);
         } else {

         }
       });
       
       // publicDB.fetchSubscriptions([querySubscription.subscriptionID]).then(function(response) {
       //   if (response.hasErrors) {  // subscription doesn't exist, so save it
           
       //       if (response.hasErrors) {
       //         console.error(response.errors[0]);
       //         throw response.errors[0];
       //       } else {
       //         console.log("successfully saved subscription")
       //       }
       //     });
       //   }
       // });

     });

     test("It updates existing facilities", (resolve, reject) => {

     });

     test("It removes exisiting facilities", (resolve, reject) => {

     });

    })

    });

      // * Items and Placeables
      //   * It fetches a list of all exisiting items
      //   * It fetches a list of exisiting items and placeables for a facility
      //   * It creates new items and placeables
      //   * It changes the hangar of an exisiting item
      //   * It updates the details of an exisiting item
      //   * It updates the position and rotation of an exisiting placeable
      //   * It deletes items and placeables

      // * Image Assets
      //   * TBD

      // * User Settings
      //   * TBD

      // * Organizational Settings
      //   * TBD

  </script>
</body>

